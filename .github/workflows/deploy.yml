name: Deploy Finetech to VPS

on:
  push:
    branches:
      - master # Ensure this matches your default branch name

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
          
      - name: Deploy via SSH
run: |
  ssh -o StrictHostKeyChecking=no "${{ secrets.VPS_USER }}@${{ secrets.SSH_HOST }}" << EOF
    set -e
    echo "Connected to $(hostname) as $(whoami)"

    cd /finetech

    # Pull latest changes
    git fetch origin master
    git reset --hard origin/master

    # Stop and remove old containers
    docker compose down --remove-orphans

    # (Optional) Remove unused volumes
    docker volume prune -f

    # Remove old images
    docker image prune -af

    # Build fresh images and start new containers
    docker compose up -d --build

    echo "Deploy completed successfully"
  EOF

